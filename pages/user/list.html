<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-control" content="no-cache">
    <title>用户管理</title>
    <link rel="stylesheet" type="text/css" href="../../static/css/themes/default/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="../../static/css/themes/bootstrap/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../static/css/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../static/css/hk-style.css">


    <script type="text/javascript" src="../../static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../static/js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../static/js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../static/js/common.js"></script>
    <script type="text/javascript" src="../../static/js/extend.js"></script>
    <script type="text/javascript" src="../../static/js/validate.js"></script>
    <script type="text/javascript" src="../../static/js/juicer-min.js"></script>


</head>
<body>
<div id="container" class="container">
    <div class="searchBox">
        <form id="searchForm">
            <div class="inputWrap">
                <label>登录名：<input type="text" name="loginName"></label>
            </div>
            <div class="inputWrap">
                <label>城市：<input type="text" name="city"></label>
            </div>
            <div class="inputWrap">
                <label>电话：<input type="text" name="tel"></label>
            </div>
            <div class="inputWrap">
                <label>公司名称：<input type="text" name="company"></label>
            </div>
            <div class="inputWrap">
                <label>个人名称：<input type="text" name="name"></label>
            </div>
        </form>
        <div class="btnWrap">
            <button class="hk-btn search" id="btnSearch">查询
            </button>
            <button class="hk-btn reset" id="btnReset">重置
            </button>
            <button class="hk-btn add" id="btnAdd">开户
            </button>

        </div>

    </div>
    <div class="searchResult">
        <div class="dgWarp">
            <div class="dgBox">
                <div id="billLog"></div>
            </div>
        </div>
    </div>

    <div id="userInfo" style="display: none">
        <table class="cells">
            <tr>
                <td class="title">编号：</td>
                <td class="content">^{idNo}</td>
                <td class="title">登录名：</td>
                <td class="content">^{loginName}</td>
            </tr>
            <tr>
                <td class="title">开户时间：</td>
                <td class="content">^{createTime}</td>
                <td class="title">服务期限：</td>
                <td class="content">
                    ^{serviceDate}
                </td>
            </tr>
            <tr>
                <td class="title">省份：</td>
                <td class="content">^{province}</td>
                <td class="title">城市：</td>
                <td class="content">^{city}</td>

            </tr>
            <tr>
                <td class="title">公司地址：</td>
                <td class="content">^{address}</td>
                <td class="title">公司名称：</td>
                <td class="content">^{company}</td>
            </tr>
            <tr>
                <td class="title">个人姓名：</td>
                <td class="content">^{name}</td>
                <td class="title">身份证号：</td>
                <td class="content">^{idNo}</td>

            </tr>
            <tr>
                <td class="title">电话：</td>
                <td class="content">^{tel}</td>
                <td class="title">用户类型：</td>
                <td class="content">^{userType}</td>
            </tr>


            <tr>
                <td class="title">状态：</td>
                <td class="content">^{lockStatus}</td>
                <td class="title">密码：</td>
                <td class="content">^{password}</td>
            </tr>

            <tr>
                <td class="title">客户端版本：</td>
                <td class="content">^{client_version}</td>
            </tr>


        </table>
        </form>
    </div>

    <div id="user" style="display: none">
        <form name="userForm">
            <table class="cells">
                <tr>
                    <td class="title">登录名：</td>
                    <td class="content"><input type="text" name="loginName"></td>
                </tr>
                <tr>
                    <td class="title">密码：</td>
                    <td class="content"><input type="text" name="password"></td>
                </tr>
                <tr>
                    <td class="title">确认密码：</td>
                    <td class="content"><input type="text" name="pwdConfirm"></td>
                </tr>
                <tr>
                    <td class="title">试用天数：</td>
                    <td class="content"><input type="text" name="trialDays"></td>
                </tr>
                <tr>
                    <td class="title">公司名称：</td>
                    <td class="content"><input type="text" name="company"></td>
                </tr>
                <tr>
                    <td class="title">公司地址：</td>
                    <td class="content"><input type="text" name="address"></td>
                </tr>
                <tr>
                    <td class="title">个人姓名：</td>
                    <td class="content"><input type="text" name="name"></td>
                </tr>
                <tr>
                    <td class="title">个人身份证号：</td>
                    <td class="content"><input type="text" name="idNo"></td>
                </tr>
                <tr>
                    <td class="title">用户类型：</td>
                    <td class="content">
                        <label><input type="radio" name="userType" value="司机" checked>&nbsp;司机</label>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label><input type="radio" name="userType" value="配货站">&nbsp;&nbsp;配货站</label>
                    </td>
                </tr>
                <tr>
                    <td class="title">手机号：</td>
                    <td class="content"><input type="text" name="mobile"></td>
                </tr>

            </table>
        </form>
    </div>

    <div id="renew" style="display: none">
        <form name="renewForm">
            <table class="cells">
                <tr>
                    <td class="title">续费时间：</td>
                    <td class="content"><input type="text" name="num"></td>
                </tr>
                <tr>
                    <td class="title">时间单位：</td>
                    <td class="content">
                        <label><input type="radio" name="timeType" value="MOUNTH" checked>&nbsp;月</label>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label><input type="radio" name="timeType" value="YEAR">&nbsp;年</label>
                    </td>
                </tr>
            </table>
        </form>
    </div>


    <div id="updatePwd" style="display: none">
        <form name="updatePwdForm">
            <table class="cells">
                <tr>
                    <td class="title">密码：</td>
                    <td class="content"><input type="text" name="password"></td>
                </tr>
                <tr>
                    <td class="title">确认密码：</td>
                    <td class="content"><input type="text" name="pwdConfirm"></td>
                </tr>


            </table>
        </form>
    </div>

</div>
</div>

</body>
<script>

    juicer.set({
        'tag::operationOpen': '{@',
        'tag::operationClose': '}',
        'tag::interpolateOpen': '^{',
        'tag::interpolateClose': '}',
        'tag::noneencodeOpen': '&&{',
        'tag::noneencodeClose': '}',
        'tag::commentOpen': '{#',
        'tag::commentClose': '}'
    });

    function list() {
        var params = $("#searchForm").serializeJson()
        $("#billLog").datagrid({
            title: "用户列表",
            url: '/user/list',
            queryParams: params,
            rownumbers: false,
            singleSelect: true,
            columns: [[
                {
                    field: 'cbo',
                    checkbox: true
                },
                {
                    field: 'number',
                    title: '序号',
                    width: '3%',
                    align: 'center'
                },
                {
                    field: 'loginName',
                    title: '登录名',
                    width: '150',
                    align: 'center',
                    formatter: function (value, row, index) {
                        return '<a href="javascript:void(0)" onclick="userInfoPanel(event,\'' + encodeURI(JSON.stringify(row)) + '\')">' + value + '</a>'
                    }
                },
                {
                    field: 'userType',
                    title: '用户类型',
                    width: '80',
                    align: 'center'
                },
                {
                    field: 'memberType',
                    title: '会员类型',
                    width: '80',
                    align: 'center'
                },
                {
                    field: 'createTime',
                    title: '开户时间',
                    width: '135',
                    align: 'center',
                    formatter: function (value, row, index) {
                        return $.converToCNDate(value)
                    }
                },
                {
                    field: 'serviceDate',
                    title: '服务期限',
                    width: '135',
                    align: 'center',
                    formatter: function (value, row, index) {
                        return $.converToCNDate(value)
                    }
                },
                {
                    field: 'company',
                    title: '公司名称',
                    align: 'center',
                    width: '200',
                },


                {
                    field: 'address',
                    title: '公司地址',
                    width: '200',
                    align: 'center'
                },
                {
                    field: 'name',
                    title: '个人名称',
                    width: '100',
                    align: 'center'
                },
                {
                    field: 'idNo',
                    title: '个人身份证号码',
                    width: '150',
                    align: 'center'
                },

            ]],
            pagination: true,
            onLoadSuccess: function (data) {
            }
        })
    }

    function addUser() {
        $.createOnlyDiv('user-dialog');
        var $dialog=$("#user-dialog")
        $dialog.dialog({
            title: '【开户】',
            width: 400,
            height: 420,
            closed: false,
            cache: false,
            modal: true,
            content: $("#user").html(),
            buttons: [{
                text: '提交处理',
                iconCls: 'icon-save',
                handler: function () {
                    var userForm = $("#user-dialog").find("form[name=userForm]");
                    if (userForm.form("validate")) {
                        var data = userForm.serializeJson();
                        if(data.mobile&&typeof data.mobile=='object'){
                            data.mobile=data.mobile.join(',')
                        }
                        common.ajax({
                            url: '/user/add',
                            type: "post",
                            data: data,
                            succ: function (res) {
                                $("#user-dialog").dialog("destroy");
                                $.messager.alert('提示', '开户成功');
                                list()
                            }
                        });
                    }


                }
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $("#user-dialog").dialog('destroy');
                }
            }]
        })
        $dialog.find("input[name=loginName]").validatebox({
            required: true,
            validateOnCreate: false
        });
        $dialog.find("input[name=password]").passwordbox({
            showEye: true,
            required: true,
            validateOnCreate: false,
            validType: 'pwd'
        });
        $dialog.find("input[name=pwdConfirm]").passwordbox({
            showEye: true,
            required: true,
            validateOnCreate: false,
            validType: "equlse['input[name=password].textbox-value']"

        });
        $dialog.find("input[name=trialDays]").numberbox({
            required: true,
            min: 0,
            validateOnCreate: false,
        });
        $dialog.find("input[name=company]").validatebox({
            required: true,
            validateOnCreate: false
        });
        $dialog.find("input[name=name]").validatebox({});
        $dialog.find("input[name=idNo]").validatebox({
            validType: 'idcard'
        });
        $dialog.find("input[name=mobile]").textbox({
            validType: 'moblie',
            icons: [{
                iconCls:'icon-add',
                handler: function(e){
                    $dialog.find("table").append('<tr><td class="title"></td><td class="content"><input type="text" name="mobile"></td></tr>').find("input[name=mobile]").textbox({
                        icons:[{
                            iconCls:'icon-cancel',
                            handler:function (e) {
                                $(this).parents("tr").remove()
                            }
                        }]
                    })

                }
            }]
        });

    }

    function userInfoPanel(e, data) {
        e.preventDefault();
        e.stopPropagation();
        data = JSON.parse(decodeURI(data))

        data.lockStatus = data.lockStatus ? "已锁定" : "正常"
        data.createTime = $.converToCNDate(data.createTime)

        data.serviceDate = $.converToCNDate(data.serviceDate)


        console.info($("#userInfo").html())
        $.createOnlyDiv('userInfo-dialog');
        $("#userInfo-dialog").dialog({
            title: '【用户详情】',
            width: 600,
            height: 420,
            closed: false,
            cache: false,
            modal: true,
            content: juicer($("#userInfo").html(), data),
            buttons: [{
                iconCls: 'icon-sum',
                text: "续费",
                handler: function () {
                    renew(data.id)
                }
            }, {
                iconCls: 'icon-clear',
                text: "清理机器码",
                handler: function () {
                    resetMacCode(data.id)
                }
            }, {
                iconCls: 'icon-edit',
                text: "修改密码",
                handler: function () {
                    updatePwd(data.id)
                }
            }, {
                iconCls: 'icon-undo',
                text: " 踢出",
                handler: function () {
                    kickOut(data.id)
                }
            }, {
                iconCls: 'icon-lock',
                text: " 锁定",
                handler: function () {
                    lock(data)
                }
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $("#userInfo-dialog").dialog('destroy');
                }
            }]
        })
    }

    function renew(id) {
        $.createOnlyDiv('renew-dialog');
        $("#renew-dialog").dialog({
            title: '【续费】',
            width: 400,
            height: 170,
            closed: false,
            cache: false,
            modal: true,
            content: $("#renew").html(),
            buttons: [{
                text: '提交处理',
                iconCls: 'icon-save',
                handler: function () {
                    var numberbox = $("#renew-dialog").find("input[numberboxname=num]")
                    if (numberbox.numberbox("isValid")) {
                        $.messager.confirm("提示", "您确定给该用户续费吗？", function (result) {
                            if (result) {
                                var num = numberbox.numberbox("getValue");
                                var timeType = $("#renew-dialog").find("input[type=radio]:checked").val();
                                var data = {userId: id, "num": num, "timeType": timeType}
                                common.ajax({
                                    url: '/user/renew',
                                    type: "post",
                                    data: data,
                                    succ: function (res) {
                                        $("#renew-dialog").dialog("destroy");
                                        $.messager.alert('提示', '续费成功');
                                        list()
                                    }
                                });
                            }
                        })
                    } else {
                        numberbox.numberbox("focus").next("span").find('input[type=text]').focus()
                    }


                }
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $("#renew-dialog").dialog('destroy');
                }
            }]
        })
        $("#renew-dialog").find("input[name=num]").numberbox({
            required: true,
            min: 0,
            validateOnCreate: false,
        });
    }

    function resetMacCode(id) {
        $.messager.confirm("提示", "您确定清理该用户的机器码吗？", function (result) {
            if (result) {
                common.ajax({
                    url: '/user/resetMacCode',
                    type: "post",
                    data: {userId: id},
                    succ: function (res) {
                        $.messager.alert('提示', '清理成功');
                        list()
                    }
                });
            }
        })
    }

    function updatePwd(id) {
        $.createOnlyDiv('updatePwd-dialog');
        $("#updatePwd-dialog").dialog({
            title: '【修改密码】',
            width: 400,
            height: 170,
            closed: false,
            cache: false,
            modal: true,
            content: $("#updatePwd").html(),
            buttons: [{
                text: '提交处理',
                iconCls: 'icon-save',
                handler: function () {
                    var updatePwdForm = $("#updatePwd-dialog").find("form[name=updatePwdForm]");
                    if (updatePwdForm.form("validate")) {
                        var data = updatePwdForm.serializeJson();
                        common.ajax({
                            url: '/user/updatePwd',
                            type: "post",
                            data: {userId: id, password: data.password},
                            succ: function (res) {
                                $("#updatePwd-dialog").dialog("destroy");
                                $.messager.alert('提示', '修改密码成功');
                                // list()
                            }
                        });
                    }
                }
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $("#updatePwd-dialog").dialog('destroy');
                }
            }]
        })
        $("#updatePwd-dialog").find("input[name=password]").passwordbox({
            showEye: true,
            required: true,
            validateOnCreate: false,
            validType: 'pwd'
        });
        $("#updatePwd-dialog").find("input[name=pwdConfirm]").passwordbox({
            showEye: true,
            required: true,
            validateOnCreate: false,
            validType: "equlse['input[name=password].textbox-value']"

        });

    }

    function kickOut(id) {
        $.messager.confirm("提示", "您确定踢出该用户吗？", function (result) {
            if (result) {
                common.ajax({
                    url: '/user/kickOut',
                    type: "post",
                    data: {userId: id},
                    succ: function (res) {
                        $.messager.alert('提示', '踢出成功');
                        list()
                    }
                });
            }
        })
    }

    function lock(data) {
        var text = "您确定锁定该用户吗？";
        if (data.lockStatus) {
            text = "您确定解锁该用户吗？";
        }
        $.messager.confirm("提示", text, function (result) {
            if (result) {
                common.ajax({
                    url: '/user/lock',
                    type: "post",
                    data: {userId: data.id, status: !data.lockStatus},
                    succ: function (res) {
                        $.messager.alert('提示', '锁定成功');
                        list()
                    }
                });
            }
        })
    }

    $(function () {
        list()
        $("#btnSearch").click(list);
        //重置按钮
        $("#btnReset").click(function () {
            $("#searchForm").form('reset');
        })

        $("#btnAdd").click(addUser)
    })
</script>
</html>
